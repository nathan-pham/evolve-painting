var P=Object.defineProperty;var U=(n,t,s)=>t in n?P(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s;var c=(n,t,s)=>(U(n,typeof t!="symbol"?t+"":t,s),s);import"https://cdn.jsdelivr.net/npm/ionicons/dist/ionicons/ionicons.esm.js";var g=(n,t)=>t?Math.random()*(t-n)+n:Math.random()*n,u=n=>Math.round(g(n));var O=class{constructor(t,s,e){c(this,"vertices",[]);c(this,"color",{r:0,g:0,b:0,a:0});if(s&&e){for(let o=0;o<s;o++)this.vertices.push([u(t.width),u(t.height)]);switch(e){case"black":this.color={r:0,g:0,b:0,a:.001};break;case"white":this.color={r:255,g:255,b:255,a:.001};break;default:this.color={r:random(255),g:random(255),b:random(255),a:.001}}}}render(t){t.fillStyle=`rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.color.a})`,t.beginPath();let[s,e]=this.vertices[0];t.moveTo(s,e);for(let o of this.vertices.slice(1))t.lineTo(o[0],o[1]);t.closePath(),t.fill()}},b=O;var r=(n="div",t={},...s)=>{let e=document.createElement(n);for(let[o,i]of Object.entries(t))o.startsWith("on")?e.addEventListener(o.substring(2).toLowerCase(),i):o=="className"?e.className=i:e.setAttribute(o,i);for(let o of s)e.appendChild(typeof o=="string"?document.createTextNode(o):o);return e},C=(n,t)=>typeof n=="string"&&!t?document.querySelectorAll(n):n.querySelectorAll(t);var f=(n,t,s)=>{let e=(l,m)=>Object.keys(l).reduce((d,h)=>({...d,[h]:m(l[h])}),{}),o=window.devicePixelRatio||1,i=n.getContext("2d");Object.assign(n,e(t,l=>Math.floor(l*o))),Object.assign(n.style,e(t,l=>l/s+"px")),i.scale(o,o)},y=async n=>new Promise((t,s)=>{let e=new Image;e.crossOrigin="Anonymous",e.onload=()=>t(e),e.onerror=async()=>{console.log("failed to load image, using mona lisa instead"),t(await y("/js/libs/evolution/mona-lisa.jpg"))},e.src=n}),w=(n,t,s)=>{let e=n.getContext("2d"),o=t.width/t.height,i=parseInt(n.style.width)*s,l=parseInt(n.style.height)*s,m=i,d=m/o;d<l&&(d=l,m=d*o);let h=m>i?(i-m)/2:0,p=d>l?(l-d)/2:0;e.fillStyle="rgb(255, 255, 255)",e.fillRect(0,0,i,l),e.drawImage(t,h,p,m,d)},I=(n,t)=>{let s=1024,e=s/n,o=r("canvas",{width:s,height:s}),i=o.getContext("2d");i.fillStyle="rgb(255, 255, 255)",i.fillRect(0,0,s,s);for(let l of t){i.fillStyle=`rgba(${l.color.r}, ${l.color.g}, ${l.color.b}, ${l.color.a})`,i.beginPath();let[m,d]=l.vertices[0];i.moveTo(m*e,d*e);for(let h of l.vertices.slice(1))i.lineTo(h[0]*e,h[1]*e);i.closePath(),i.fill()}r("a",{style:"display: none",download:"image-evolution.png",href:o.toDataURL("image/png")}).click()};var v=class{constructor(t,s,e,o){c(this,"dimensions",{});c(this,"polygons",[]);c(this,"fitness",-1);if(this.dimensions=t,Array.isArray(s))this.polygons=s,this.fitness=e;else for(let l=0;l<s;l++)this.polygons.push(new b(this.dimensions,e,o));let i=document.createElement("canvas");f(i,this.dimensions),this.testCtx=i.getContext("2d")}render(t){t.fillStyle="rgb(255, 255, 255)",t.fillRect(0,0,this.dimensions.width,this.dimensions.height);for(let s of this.polygons)s.render(t)}clone(){let t=[];for(let s of this.polygons){let e=new b(this.dimensions);Object.assign(e,{color:{...s.color},vertices:s.vertices.reduce((o,i)=>[...o,[...i]],[])}),t.push(e)}return new v(this.dimensions,[...t],this.fitness)}mutate(t){let s=Math.floor(g(this.polygons.length)),e=this.polygons[s];switch(t){case"medium":{let o=g(2);if(o<1)o<.25?e.color.r=u(255):o<.5?e.color.g=u(255):o<.75?e.color.b=u(255):o<1&&(e.color.a=Math.random());else{let i=Math.floor(g(this.polygons[0].vertices.length));o<1.5?e.vertices[i][0]=u(this.dimensions.width):e.vertices[i][1]=u(this.dimensions.height)}}}this.polygons[s]=e}calculateFitness(t){let s=0;this.testCtx.fillStyle="rgb(255, 255, 255)",this.testCtx.fillRect(0,0,this.dimensions.width,this.dimensions.height),this.render(this.testCtx);let e=this.testCtx.getImageData(0,0,this.dimensions.width,this.dimensions.height);for(let o=0;o<t.data.length;o++)o%4!=3&&(s+=Math.abs(t.data[o]-e.data[o]));return s}},S=v;var T=class{constructor({dimensions:t,polygonCount:s=50,verticeCount:e=6,mutationMode:o="medium",dnaMode:i="black"}){c(this,"mutationMode",.05);c(this,"verticeCount",4);c(this,"dimensions",{});c(this,"mutations",0);c(this,"improvements",0);c(this,"normalizedFitness",0);c(this,"bestFitness",Infinity);c(this,"bestPopulation",{});this.mutationMode=o,this.dimensions=t,this.population=new S(t,s,e,i)}core(t,s){this.population.mutate(this.mutationMode),this.mutations++,this.population.fitness=this.population.calculateFitness(s);let e=this.dimensions.width*this.dimensions.height*3*255;this.population.fitness<this.bestFitness?(this.bestFitness=this.population.fitness,this.bestPopulation=this.population.clone(),this.improvements++,this.normalizedFitness=100*(1-this.bestFitness/e),this.bestPopulation.render(t)):this.population=this.bestPopulation.clone()}},x=T;var R=(n,...t)=>{let s=r("div",{className:"modal-wrapper"},r("div",{className:"modal"},r("div",{className:"icon",onClick:()=>{s.remove(),document.body.style.overflow=""}},r("ion-icon",{name:"close-outline"})),r("h1",{},n||"modal"),...t));return document.body.style.overflow="hidden",s};var N=(n="unnamed-input",t)=>r("div",{className:"input-wrapper"},r("input",{type:"range",...t}),r("label",{for:t.name||t.id||"unnamed-input"},n));var a={SOURCE_PATH:"/js/libs/evolution/mona-lisa.jpg",RESOLUTION_FACTOR:1,POLYGON_COUNT:50,VERTICE_COUNT:6,EV_ID:0},A=async()=>{let[n,t]=C("canvas"),s=C("#settings")[0],e=C("#evolve")[0],o={width:n.offsetWidth*a.RESOLUTION_FACTOR,height:n.offsetWidth*a.RESOLUTION_FACTOR};f(n,o,a.RESOLUTION_FACTOR),f(t,o,a.RESOLUTION_FACTOR),w(n,await y(a.SOURCE_PATH),a.RESOLUTION_FACTOR);let i=new x({dimensions:o,polygonCount:a.POLYGON_COUNT,verticeCount:a.VERTICE_COUNT}),l=n.getContext("2d"),m=t.getContext("2d"),d=l.getImageData(0,0,o.width,o.height),h;s.onclick=()=>{h=R("Settings",r("p",{},"Changing settings will reset evolution."),r("p",{id:"statistics"},"Start evolution to see statistics."),r("input",{placeholder:"/js/libs/evolution/mona-lisa.jpg",value:a.SOURCE_PATH,type:"text"}),N(`${a.POLYGON_COUNT}/1000 Polygons`,{min:10,max:1e3,value:a.POLYGON_COUNT,name:"polygons",onChange:p=>p.target.parentNode.querySelector("label").textContent=`${p.target.value}/1000 Polygons`}),N(`${a.VERTICE_COUNT}/100 Vertices`,{min:3,max:100,value:a.VERTICE_COUNT,name:"vertices",onChange:p=>p.target.parentNode.querySelector("label").textContent=`${p.target.value}/100 Vertices`}),r("div",{className:"options"},r("button",{className:"secondary",onClick:()=>{I(o.width,i.population.polygons)}},"Download Image"),r("button",{onClick:async()=>{let[p,_,j]=h.querySelectorAll("input"),E=p.value;w(n,await y(E),a.RESOLUTION_FACTOR),d=l.getImageData(0,0,o.width,o.height),a={...a,SOURCE_PATH:E,POLYGON_COUNT:parseInt(_.value),VERTICE_COUNT:parseInt(j.value)},i=new x({dimensions:o,polygonCount:a.POLYGON_COUNT,verticeCount:a.VERTICE_COUNT}),e.textContent.toLowerCase().includes("start")&&clearInterval(a.EV_ID),h.querySelector(".icon").click(),h=null}},"Save Settings"))),document.body.appendChild(h)},e.onclick=()=>{e.textContent.toLowerCase().includes("start")?(e.textContent="Stop Evolving",a.EV_ID=setInterval(()=>{i.core(m,d),h&&document.body.contains(h)&&(document.getElementById("statistics").textContent=`mutations: ${i.mutations}, improvements: ${i.improvements}, fitness: ${i.normalizedFitness.toFixed(2)}%`)},0)):(e.textContent="Start Evolving",clearInterval(a.EV_ID))}};A();
//# sourceMappingURL=index.js.map
